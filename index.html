<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BidFlow - Placement Optimizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e15;
            --bg-card: #111827;
            --bg-hover: #1a2332;
            --accent-primary: #00ff94;
            --accent-secondary: #0095ff;
            --accent-warning: #ff9500;
            --accent-danger: #ff3366;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border: #1f2937;
            --shadow: rgba(0, 255, 148, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            position: relative;
        }

        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            z-index: 0;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .content {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-zone {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: var(--accent-primary);
            background: var(--bg-hover);
            box-shadow: 0 0 40px var(--shadow);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 4px 12px rgba(0, 255, 148, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 148, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 30px var(--shadow);
        }

        .stat-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-detail {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .table-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .table-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        input, select {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 148, 0.1);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        thead {
            background: var(--bg-hover);
        }

        th {
            padding: 0.5rem 0.3rem;
            text-align: left;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
            font-weight: 700;
            cursor: pointer;
            transition: color 0.3s ease;
            white-space: nowrap;
            line-height: 1.3;
        }

        th:hover {
            color: var(--accent-primary);
        }

        td {
            padding: 0.6rem 0.3rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
        }

        tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-hover);
        }

        .metric-positive {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .metric-negative {
            color: var(--accent-danger);
            font-weight: 600;
        }

        .multiplier {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            background: rgba(0, 255, 148, 0.1);
            color: var(--accent-primary);
        }

        .metric-group-30d {
            background: rgba(0, 255, 148, 0.08);
        }

        .metric-group-7d {
            background: rgba(0, 149, 255, 0.08);
        }

        tbody tr:hover .metric-group-30d,
        tbody tr:hover .metric-group-7d {
            background: var(--bg-hover);
        }

        .campaign-group-separator {
            border-top: 2px solid var(--accent-primary) !important;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            height: 280px;
        }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
            margin-right: 0.25rem;
        }

        .badge-top {
            background: rgba(0, 255, 148, 0.2);
            color: var(--accent-primary);
        }

        .badge-pp {
            background: rgba(0, 149, 255, 0.2);
            color: var(--accent-secondary);
        }

        .badge-ros {
            background: rgba(255, 149, 0, 0.2);
            color: var(--accent-warning);
        }

        .badge-business {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-danger);
        }

        @media (min-width: 768px) {
            .content {
                padding: 2rem;
            }

            h1 {
                font-size: 3rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .table-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .table-controls {
                flex-direction: row;
                width: auto;
            }

            table {
                font-size: 0.85rem;
            }

            th {
                font-size: 0.75rem;
                padding: 1rem 0.5rem;
            }

            td {
                padding: 1rem 0.5rem;
                font-size: 0.85rem;
            }

            .chart-container {
                height: 400px;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            GOOGLE_API_KEY: 'AIzaSyAl3vMZM_kXq1RB1Jhk_5P3_NrOHnXCTyQ',
            GOOGLE_DRIVE_FOLDER_ID: '1MZEl4NUwIq-ObppjNdK3qnRR7XFitdrA',
            N8N_WEBHOOK_URL: 'https://n8n.bidflow.app/webhook/placement-updates',
            AUTO_REFRESH_INTERVAL: 300000 // 5 minutes
        };

        function PlacementDashboard() {
            const [reports, setReports] = useState([]);
            const [filteredData, setFilteredData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [portfolioFilter, setPortfolioFilter] = useState('all');
            const [sortConfig, setSortConfig] = useState({ key: 'Campaign', direction: 'asc' });
            const [editingCell, setEditingCell] = useState(null);
            const [weeklySheets, setWeeklySheets] = useState([]);
            const [currentSheet, setCurrentSheet] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                fetchWeeklySheets();
                const interval = setInterval(() => {
                    if (currentSheet) fetchSheetData(currentSheet.id);
                }, CONFIG.AUTO_REFRESH_INTERVAL);
                return () => clearInterval(interval);
            }, []);

            const fetchWeeklySheets = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(
                        `https://www.googleapis.com/drive/v3/files?` +
                        `q='${CONFIG.GOOGLE_DRIVE_FOLDER_ID}'+in+parents+and+mimeType='application/vnd.google-apps.spreadsheet'` +
                        `&key=${CONFIG.GOOGLE_API_KEY}` +
                        `&fields=files(id,name)` +
                        `&orderBy=name desc`
                    );
                    if (!response.ok) throw new Error('Failed to fetch sheets');
                    const data = await response.json();
                    const sheets = data.files.map(file => ({
                        id: file.id,
                        name: file.name,
                        weekNumber: extractWeekNumber(file.name)
                    }));
                    setWeeklySheets(sheets);
                    if (sheets.length > 0) {
                        setCurrentSheet(sheets[0]);
                        await fetchSheetData(sheets[0].id);
                    }
                } catch (error) {
                    console.error('Error fetching weekly sheets:', error);
                } finally {
                    setLoading(false);
                }
            };

            const extractWeekNumber = (filename) => {
                const match = filename.match(/Week(\d+)/i);
                return match ? `Week ${match[1]}` : filename;
            };

            const fetchSheetData = async (sheetId) => {
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/USA!A:W?key=${CONFIG.GOOGLE_API_KEY}`
                    );
                    if (!response.ok) throw new Error('Failed to fetch sheet data');
                    const data = await response.json();
                    const rows = data.values;
                    if (!rows || rows.length === 0) return;
                    const headers = rows[0];
                    const parsedData = rows.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((h, i) => obj[h] = row[i] || '');
                        return obj;
                    }).filter(row => row.Campaign && row.Campaign !== '0');
                    setReports(parsedData);
                    setFilteredData(parsedData);
                } catch (error) {
                    console.error('Error fetching sheet data:', error);
                }
            };

            const handleWeekChange = async (sheetId) => {
                const selectedSheet = weeklySheets.find(s => s.id === sheetId);
                setCurrentSheet(selectedSheet);
                setLoading(true);
                await fetchSheetData(sheetId);
                setLoading(false);
            };

            useEffect(() => {
                let filtered = reports;
                if (searchTerm) {
                    filtered = filtered.filter(row => 
                        (row.Campaign || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                        (row.Portfolio || '').toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                if (portfolioFilter !== 'all') {
                    filtered = filtered.filter(row => row.Portfolio === portfolioFilter);
                }
                filtered = [...filtered].sort((a, b) => {
                    const campaignA = (a.Campaign || '').toLowerCase();
                    const campaignB = (b.Campaign || '').toLowerCase();
                    if (campaignA !== campaignB) return campaignA.localeCompare(campaignB);
                    const order = { 'placement top': 1, 'placement rest of search': 2, 'placement product page': 3, 'placement amazon business': 4 };
                    return (order[(a['Placement Type'] || '').toLowerCase()] || 999) - (order[(b['Placement Type'] || '').toLowerCase()] || 999);
                });
                setFilteredData(filtered);
            }, [reports, searchTerm, portfolioFilter, sortConfig]);

            useEffect(() => {
                if (filteredData.length > 0 && chartRef.current) createChart();
                return () => chartInstance.current?.destroy();
            }, [filteredData]);

            const createChart = () => {
                chartInstance.current?.destroy();
                const ctx = chartRef.current.getContext('2d');
                const placementData = {};
                filteredData.forEach(row => {
                    const p = row['Placement Type'] || 'Unknown';
                    if (!placementData[p]) placementData[p] = { spend: 0, clicks: 0 };
                    placementData[p].spend += parseFloat(row['Spend-7'] || 0);
                    placementData[p].clicks += parseFloat(row['Clicks-7'] || 0);
                });
                const labels = Object.keys(placementData);
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => l.replace('Placement ', '')),
                        datasets: [
                            { label: 'Spend (7d)', data: labels.map(l => placementData[l].spend), backgroundColor: 'rgba(0, 255, 148, 0.6)', yAxisID: 'y' },
                            { label: 'Clicks (7d)', data: labels.map(l => placementData[l].clicks), backgroundColor: 'rgba(0, 149, 255, 0.6)', yAxisID: 'y1' }
                        ]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } }
                    }
                });
            };

            const stats = (() => {
                const s7 = filteredData.reduce((s, r) => s + parseFloat(r['Spend-7'] || 0), 0);
                const c7 = filteredData.reduce((s, r) => s + parseFloat(r['Clicks-7'] || 0), 0);
                const o7 = filteredData.reduce((s, r) => s + parseFloat(r['Orders-7'] || 0), 0);
                return { s7, c7, o7, cvr: c7 > 0 ? (o7 / c7 * 100) : 0 };
            })();

            const formatCurrency = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v || 0);
            const formatPercent = (v) => `${(parseFloat(v) || 0).toFixed(2)}%`;

            const handleChangeEdit = (index, newValue) => {
                const updated = [...reports];
                const dataIndex = reports.findIndex(item => item.Campaign === filteredData[index].Campaign && item['Placement Type'] === filteredData[index]['Placement Type']);
                if (dataIndex !== -1) {
                    let val = newValue.trim();
                    if (val && !isNaN(val)) val += '%';
                    updated[dataIndex]['Changes in placement'] = val;
                    setReports(updated);
                }
                setEditingCell(null);
            };

            // CORRECTED SUBMISSION LOGIC FOR CORS
            const handleSubmitChanges = async () => {
                const changesData = reports.filter(row => 
                    row['Changes in placement'] && row['Changes in placement'] !== '-' && row['Changes in placement'].trim() !== ''
                ).map(row => ({
                    campaign: row.Campaign,
                    portfolio: row.Portfolio,
                    placement: row['Placement Type'],
                    currentMultiplier: row['Increase bids by placement'],
                    newMultiplier: row['Changes in placement'],
                    week: currentSheet?.weekNumber || 'Unknown'
                }));

                if (changesData.length === 0) return alert('No changes to submit.');
                if (!confirm(`Submit ${changesData.length} changes to Amazon?`)) return;

                try {
                    setSubmitting(true);
                    const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
                        method: 'POST',
                        mode: 'cors', // REQUIRED
                        credentials: 'omit', // REQUIRED for wildcard CORS
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({ changes: changesData, week: currentSheet?.weekNumber })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    alert('✅ Successfully submitted!');
                } catch (error) {
                    console.error('Submission failed:', error);
                    alert(`❌ Error: ${error.message}. Check Nginx CORS settings.`);
                } finally {
                    setSubmitting(false);
                }
            };

            if (loading && weeklySheets.length === 0) return <div className="loading">Loading...</div>;

            return (
                <div className="app-container">
                    <div className="bg-grid"></div>
                    <div className="content">
                        <header><h1>Placement Optimizer</h1></header>
                        <div className="stats-grid">
                            <div className="stat-card"><div className="stat-label">Spend (7d)</div><div className="stat-value">{formatCurrency(stats.s7)}</div></div>
                            <div className="stat-card"><div className="stat-label">Clicks (7d)</div><div className="stat-value">{stats.c7}</div></div>
                            <div className="stat-card"><div className="stat-label">CVR (7d)</div><div className="stat-value">{formatPercent(stats.cvr)}</div></div>
                        </div>
                        <div style={{textAlign: 'right', marginBottom: '1rem'}}>
                            <button className="btn" onClick={handleSubmitChanges} disabled={submitting}>{submitting ? 'Submitting...' : 'Submit to Amazon'}</button>
                        </div>
                        <div className="chart-container"><canvas ref={chartRef}></canvas></div>
                        <div className="data-table">
                            <div className="table-wrapper">
                                <table>
                                    <thead><tr><th>Campaign</th><th>Place</th><th>Spend 7d</th><th>Multiplier</th><th>Changes</th></tr></thead>
                                    <tbody>
                                        {filteredData.map((row, i) => (
                                            <tr key={i}>
                                                <td>{row.Campaign}</td>
                                                <td>{row['Placement Type']}</td>
                                                <td>{formatCurrency(row['Spend-7'])}</td>
                                                <td>{row['Increase bids by placement']}%</td>
                                                <td onClick={() => setEditingCell(i)}>
                                                    {editingCell === i ? 
                                                        <input autoFocus onBlur={(e) => handleChangeEdit(i, e.target.value)} defaultValue={row['Changes in placement']} /> : 
                                                        (row['Changes in placement'] || '-')
                                                    }
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.render(<PlacementDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
